---
title: The-GNU-linker
date: 2021-07-25 15:53:10
tags:
---

GNU链接器
作者： Steve Chamberlain, Ian Lance Taylor.   @Red Hat Inc


# 简介
ld链接器可以组合一组object文件和archive文件，重定位这些文件中的数据，重新绑定这些文件中的符号引用。通常在编译一个程序的最后阶段就是运行ld链接器程序。

ld会读取一个‘Linker Command Language’所写的文件作为输入，这个语言是AT&T Linker Editor Command Language的一个语法超集。这个文件会提供控制链接的全部过程。目前版本的ld使用通用的BFD库来操作目标文件。BFD库提供了ld链接器所需要的各种格式（比如COFF、a.out格式）的文件读取、拼接、写obj文件的功能。不同格式的文件也可以链接到一起来产生一个可用类型的obj文件。

相比较与其他链接器，ld不仅使用灵活，还提供了很多很有用的诊断类信息。很多其他的链接器会在遇到error的时候会理解停止执行，但是ld会继续执行，这样可以让你看看后面是不是还会由其他错误。有些时候，尽管出现了错误，最后还是会产生一个输出文件。

# 使用方法
ld注定是要处理各种各样的链接场景，然后还得尽可能的保证和其他链接器兼容。最后的结果就是，你有多种方式来控制它的行为。

## 命令行选项
ld支持非常多的命令行选项，但是实际上只有非常少的一部分是在任何场景中都适用的。举个例子，ld常用来链接标准的Unix obj文件，在Unix系统中，链接一个文件hello.o是这样使用的：
`ld -o output /lib/crt0.o hello.o -lc`

这个命令会告诉ld产生一个名为ouput的输出文件作为链接的结果，链接的过程是将文件/lib/crt0.o，hello.o和标准搜索目录下的库libc.a链接在一起。

ld的一些命令行参数可以在命令的任何位值声明。不过呢，用来修饰文件的参数，比如-l, -T，这些参数会决定ld在什么时候读取文件，因此这些参数的出现顺序和位置是有讲究的。重复的非文件修饰参数，如果有不同的值，那么这些声明的参数要么就都不起效果，由么就是后面的覆盖前面的效果。一些特殊情况的命令行参数会在下面单独说明。

必选的参数是Obj文件或者archive归档文件，这些文件会最终被链接到一起。它们可以跟在命令行参数后面，也可以放在命令行参数前面，也可以交叉着来。但是文件不能放在命令行选项和它们的值之间。

通常至少提供了一个obj文件链接器彩绘启动，但是你可以通过-l, -R参数来声明其他类型的二进制文件来作为输入文件，然后通过链接脚本来控制链接过程。如果没有一个二进制文件作为输入，那链接器不会产生任何输出文件，并且会声明一个错误： no input files.

如果链接器不能识别obj文件的格式，那么ld会将这个文件识别为一个链接器参数脚本。链接器参数脚本声明了链接过程中使用的各种参数（注意区别下链接器参数脚本和默认的链接器脚本，以及由参数-T声明的链接器脚本）。有了这样的机制，链接器就可以链接那些只定义了一些符号，或者通过INPUT和GROUP来引入其他Obj文件的obj文件或archive文件。这种方式只提供给链接脚本一些使用的参数，然后使用-T选项来替换整个默认的链接脚本，但是需要注意INSERT命令的副作用。

对于那些单个字母的命令行参数，可以使用一个短横线或者两个短横线来标识，比如，--trace-symbol和-trace-symbol是等价的。注意，这个规则有一个例外情况：以小写的o打头的多个字母的命令行选项必须以两个短横线来标识。这个是为了避免和-o选项弄混淆。举个例子,-omagic选项是声明输出文件名为magic，但是--omagic选项的作用是设置输出文件中的NMAGIC flag。

多个字母的命令行选项的参数必须用等号来和选项自身分隔开，或者让参数紧跟着命令行选项。比如，--trace-symbol foo和 --trace-symbol=foo 是等价的。多个字母的命令行选项一般可以缩写为一个没有歧义的选项。

注意： 如果链接器是被间接调用的，比如通过一个编译器(gcc)驱动，那么所有的链接器命令行选项都必须以-Wl为前缀，举个例子： gcc -Wl,--start-group foo.o bar.o -Wl,--end-group
这个规则很重要，因为如果不通过这种方式声明的话，编译器驱动的程序可能会悄悄地丢掉一些链接器参数，造成链接失败。在通过编译器传递一些选项参数的值的时候，有些时候会让人产生疑惑，甚至可能会将选项传递给链接器，但是选项的参数却传递给编译器了。在这种情况下，最简单的解决办法是使用单个短横线和多字母选项混合的方式，比如这样： gcc foo.o bar.o -Wl,-eENTRY -Wl,-Map=a.map

下面是一些GNU链接器的通用命令行选项列表：
@file: 从文件file中读取命令行选项。读入的命令行选项会插入到@file参数所在的位置。如果声明的文件不存在，或者无法读取，那这个@file选项会被当作字面量解释，而且不会自动被移除。
文件file中的命令行选项以空白符隔开。单引号和双引号引起来的选项两边可以有空白字符。任何字符（包括反斜杠）都可以通过在字符前添加反斜杠的方式引入。参数file指定的文件中可以再包含file参数，这样的引用方式会以递归的形式展开

-A architecture
--architecture=architecture
    目前版本的ld中，这个选项只在Intel 960系列CPU架构中有用。在使用这种参数的ld配置中，architecture参数声明了960系列中的具体CPU架构。

-b input-format
--format=input-format
    ld可以通过配置来支持多种obj文件。如果你的ld通过这个参数进行配置的话，那-b选项可以声明输入的二进制Obj文件的格式。即使在需要ld支持多种obj格式的情况，你一般也不需要手动通过这个-b参数来显式地声明这些输入Obj的格式，这是因为ld的默认配置会根据各个机器的不同自动识别这个机器上常见的Obj格式。input-format参数是一个string文本，代表一个BFD库支持的特定的格式。你可以通过命令objdump -i命令来获取当前机器支持的所有二进制格式。

